---
import Layout from '../../layouts/Layout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
	const docs = await getCollection('docs');

	return docs
		.filter(doc => !doc.id.includes('/index'))
		.map((doc) => ({
			params: { slug: doc.id.replace(/\.(md|mdx)$/, '') },
			props: { doc },
		}));
}

type Props = {
	doc: CollectionEntry<'docs'>;
};

const { doc } = Astro.props;
const { Content } = await doc.render();

// Parse the path to get semester, subject, and lesson info
const pathParts = doc.id.split('/');
const semesterPart = pathParts[0]; // e.g., "2nd-semester"
const subject = pathParts[1];
const semester = semesterPart.replace('-semester', '');

// Get lesson title from frontmatter or generate from filename
const lessonTitle = doc.data.title || pathParts[pathParts.length - 1]
	.replace(/\.(md|mdx)$/, '')
	.split('-')
	.map(word => word.charAt(0).toUpperCase() + word.slice(1))
	.join(' ');

// Subject names mapping
const subjectNames = {
	'data-structures-algorithms': 'Data Structures & Algorithms',
	'computer-organization': 'Computer Organization and Digital Design',
	'methods-of-mathematics': 'Methods of Mathematics',
	'program-construction': 'Program Construction',
	'theory-of-electricity': 'Theory of Electricity',
	'communication-skills': 'Communication Skills',
	'ai': 'AI (Artificial Intelligence)',
	'computer-architecture': 'Computer Architecture',
	'thermodynamics': 'Thermodynamics',
	'database-systems': 'Database Systems',
	'differential-equations': 'Differential Equations (DE)',
	'operating-systems': 'Operating Systems',
	'data-communication-networking': 'Data Communication & Networking',
	'applied-statistics': 'Applied Statistics'
};

const subjectName = subjectNames[subject as keyof typeof subjectNames] || subject;
const semesterTitle = semester === '2nd' ? '2nd Semester' : '3rd Semester';

// Get all docs for prev/next navigation
const allDocs = await getCollection('docs');
const subjectPath = `${semesterPart}/${subject}`;
const subjectDocs = allDocs
	.filter(d => d.id.startsWith(subjectPath) && !d.id.includes('/index'))
	.sort((a, b) => a.id.localeCompare(b.id));

const currentIndex = subjectDocs.findIndex(d => d.id === doc.id);
const prevDoc = currentIndex > 0 ? subjectDocs[currentIndex - 1] : null;
const nextDoc = currentIndex < subjectDocs.length - 1 ? subjectDocs[currentIndex + 1] : null;

function getDocTitle(d: CollectionEntry<'docs'>): string {
	return d.data.title || d.id.split('/').pop()?.replace(/\.(md|mdx)$/, '') || 'Untitled';
}
---

<Layout title={`${lessonTitle} | ${subjectName}`}>
	<!-- Breadcrumbs -->
	<div class="text-sm breadcrumbs mb-6">
		<ul>
			<li><a href="/">Home</a></li>
			<li><a href={`/semester/${semester}`}>{semesterTitle}</a></li>
			<li><a href={`/subject/${semester}/${subject}`}>{subjectName}</a></li>
			<li class="font-semibold">{lessonTitle}</li>
		</ul>
	</div>

	<!-- Lesson Content -->
	<article class="card bg-base-100 shadow border border-base-300 mb-8">
		<div class="card-body">
			<!-- Header -->
			<div class="mb-6 pb-6 border-b border-base-300">
				<h1 class="text-4xl font-bold mb-4 text-primary">
					{lessonTitle}
				</h1>
				<div class="flex flex-wrap gap-2">
					<div class="badge badge-primary badge-lg">{subjectName}</div>
					<div class="badge badge-secondary badge-outline badge-lg">{semesterTitle}</div>
				</div>
			</div>

			<!-- Content -->
			<div class="prose max-w-none lesson-content" data-pagefind-body>
				<Content />
			</div>
		</div>
	</article>

	<!-- Previous/Next Navigation -->
	{(prevDoc || nextDoc) && (
		<div class="join grid grid-cols-2 mb-8">
			{prevDoc ? (
				<a
					href={`/lesson/${prevDoc.id.replace(/\.(md|mdx)$/, '')}`}
					class="join-item btn btn-secondary justify-start"
				>
					<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
					</svg>
					<div class="text-left">
						<div class="text-xs opacity-70">Previous</div>
						<div class="font-semibold line-clamp-1">{getDocTitle(prevDoc)}</div>
					</div>
				</a>
			) : (
				<div class="join-item"></div>
			)}

			{nextDoc ? (
				<a
					href={`/lesson/${nextDoc.id.replace(/\.(md|mdx)$/, '')}`}
					class="join-item btn btn-secondary justify-end"
				>
					<div class="text-right">
						<div class="text-xs opacity-70">Next</div>
						<div class="font-semibold line-clamp-1">{getDocTitle(nextDoc)}</div>
					</div>
					<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
					</svg>
				</a>
			) : (
				<div class="join-item"></div>
			)}
		</div>
	)}

	<!-- Back to Subject -->
	<div class="mb-8">
		<a href={`/subject/${semester}/${subject}`} class="btn btn-ghost">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" />
			</svg>
			Back to {subjectName}
		</a>
	</div>
</Layout>