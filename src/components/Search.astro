---
// Search component using Pagefind
---

<div id="search" class="form-control w-full max-w-xs">
  <div class="relative">
    <input
      type="text"
      id="search-input"
      placeholder="Search notes..."
      class="input input-bordered w-full pr-10"
    />
    <button class="btn btn-ghost btn-circle btn-sm absolute right-1 top-1/2 -translate-y-1/2">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
    </button>
  </div>
  <div id="search-results" class="mt-2 hidden">
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body p-4">
        <div id="results-container"></div>
      </div>
    </div>
  </div>
</div>

<style>
  #search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 50;
    max-height: 400px;
    overflow-y: auto;
  }

  .search-result {
    padding: 0.75rem;
    border-bottom: 1px solid #e5e7eb;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .search-result:hover {
    background-color: #f3f4f6;
  }

  .search-result:last-child {
    border-bottom: none;
  }

  .result-title {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.25rem;
  }

  .result-excerpt {
    font-size: 0.875rem;
    color: #6b7280;
    line-height: 1.5;
  }

  .result-url {
    font-size: 0.75rem;
    color: #667eea;
    margin-top: 0.25rem;
  }
</style>

<script is:inline>
  // Pagefind search functionality - runs only in browser
  (function() {
    let pagefind = null;

    async function initializeSearch() {
      // Only load in browser, not during build
      if (typeof window === 'undefined') return;

      try {
        pagefind = await import('/pagefind/pagefind.js');
        await pagefind.options({
          baseUrl: '/',
        });
      } catch (error) {
        console.log('Pagefind not loaded yet - this is normal during development');
      }
    }

    async function performSearch(query) {
      if (!pagefind || !query || query.length < 2) {
        hideResults();
        return;
      }

      try {
        const search = await pagefind.search(query);
        const resultsContainer = document.getElementById('results-container');
        const resultsDiv = document.getElementById('search-results');

        if (!resultsContainer || !resultsDiv) return;

        if (search.results.length === 0) {
          resultsContainer.innerHTML = '<p class="text-sm text-gray-500">No results found</p>';
          resultsDiv.classList.remove('hidden');
          return;
        }

        // Limit to first 5 results
        const limitedResults = search.results.slice(0, 5);
        const resultData = await Promise.all(
          limitedResults.map((r) => r.data())
        );

        resultsContainer.innerHTML = resultData
          .map((result) => {
            const excerpt = result.excerpt
              .replace(/<mark>/g, '<span class="bg-yellow-200">')
              .replace(/<\/mark>/g, '</span>');

            return `
              <a href="${result.url}" class="search-result block no-underline">
                <div class="result-title">${result.meta.title || 'Untitled'}</div>
                <div class="result-excerpt">${excerpt}</div>
                <div class="result-url">${result.url}</div>
              </a>
            `;
          })
          .join('');

        resultsDiv.classList.remove('hidden');
      } catch (error) {
        console.error('Search error:', error);
      }
    }

    function hideResults() {
      const resultsDiv = document.getElementById('search-results');
      if (resultsDiv) {
        resultsDiv.classList.add('hidden');
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeSearch);
    } else {
      initializeSearch();
    }

    // Search input handler
    window.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        let debounceTimer;

        searchInput.addEventListener('input', (e) => {
          clearTimeout(debounceTimer);
          const query = e.target.value;

          debounceTimer = setTimeout(() => {
            performSearch(query);
          }, 300);
        });

        // Hide results when clicking outside
        document.addEventListener('click', (e) => {
          const searchContainer = document.getElementById('search');
          if (searchContainer && !searchContainer.contains(e.target)) {
            hideResults();
          }
        });
      }
    });
  })();
</script>
